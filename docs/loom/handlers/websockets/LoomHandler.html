<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>LoomHandler.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>LoomHandler.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.GenericHandler</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">from</span> <span class="nn">loom.database.interfaces</span> <span class="kn">import</span> <span class="n">AbstractDBInterface</span>  <span class="c1"># For type hinting.</span>

<span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="kn">from</span> <span class="nn">decorator</span> <span class="kn">import</span> <span class="n">decorator</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span>
<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">IOLoop</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="n">JSON</span> <span class="o">=</span> <span class="n">Dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">LoomWSError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Raised when a connection attempts an unimplemented task.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">LoomWSUnimplementedError</span><span class="p">(</span><span class="n">LoomWSError</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Raised when necessary arguments were omitted or formatted incorrectly.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">LoomWSBadArgumentsError</span><span class="p">(</span><span class="n">LoomWSError</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Raised when a user should be logged in but isn't.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">LoomWSNoLoginError</span><span class="p">(</span><span class="n">LoomWSError</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <h6></h6>
<h1></h1>
<h1>LoomHandler decorators</h1>
<h1></h1>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">requires_login</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LoomWSNoLoginError</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LoomHandler</span><span class="p">(</span><span class="n">GenericHandler</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <h6></h6>
<p>Generic websocket methods</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_secure_session_cookie</span><span class="p">()</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_for_session_id</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_user_id_for_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Something went wrong.&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>TODO: Clean up session</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>By default, small messages are coalesced. This can cause delay. We don't want delay.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">set_nodelay</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reply_to</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s1">&#39;reason&#39;</span><span class="p">:</span>  <span class="n">reason</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">reply_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;reply_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply_to</span>
        <span class="n">response</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_json</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">with_reply_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;reply_to_id&#39;</span><span class="p">:</span> <span class="n">with_reply_id</span><span class="p">})</span>
        <span class="n">json_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_json</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractDBInterface</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;db_interface&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ObjectId</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_user_for_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
        <span class="n">session_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session_manager&#39;</span><span class="p">]</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">session_manager</span><span class="o">.</span><span class="n">get_username_for_session_id</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Session id is not valid&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">username</span>

    <span class="k">def</span> <span class="nf">_get_secure_session_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cookie_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;session_cookie_name&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Make sure users cannot use cookies for more than their session</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">cookie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="n">cookie_name</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Might need to be set to 1?</span>
        <span class="k">return</span> <span class="n">cookie</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <h6></h6>
<p>Message handling</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>TODO: Remove this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_json</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s2">&quot;Message received was not valid JSON.&quot;</span><span class="p">,</span> <span class="n">received_message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p><code>on_message</code> may not be a coroutine (as of Tornado 4.3).
To work around this, we call spawn_callback to start a coroutine.
However, this results in errors not propagating back up.
Side effect: More messages may be received before the one below is fully executed.
See:
  https://stackoverflow.com/questions/35542864/how-to-use-python-3-5-style-async-and-await-in-tornado-for-websockets
And:
  http://stackoverflow.com/questions/33723830/exception-ignored-in-tornado-websocket-on-message-method</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">IOLoop</span><span class="o">.</span><span class="n">current</span><span class="p">()</span><span class="o">.</span><span class="n">spawn_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_message</span><span class="p">,</span> <span class="n">json</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">JSON</span><span class="p">):</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Remove the <code>action</code> key/value. It's only needed for dispatch, so the dispatch methods don't use it.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">action</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">reply_to</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;`action` field not supplied&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">message_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">LoomWSUnimplementedError</span><span class="p">:</span>
            <span class="n">err_message</span> <span class="o">=</span> <span class="s2">&quot;invalid `action`: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">reply_to</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">err_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">LoomWSBadArgumentsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">reply_to</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISPATCH</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">await</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Most likely, the wrong arguments were given.
We do some introspection to give back useful error messages.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>The first assumption is that not all of the necessary arguments were given, so check for that.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">missing_fields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;params: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                        <span class="n">missing_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">missing_fields</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>So something <em>was</em> missing!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;request of type &#39;{}&#39; missing fields: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">missing_fields</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">LoomWSBadArgumentsError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Something else has gone wrong...
Let's check if too many arguments were given.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">num_required_arguments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># We subtract 1 for `self`.</span>
                    <span class="n">num_given_arguments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">num_required_arguments</span> <span class="o">!=</span> <span class="n">num_given_arguments</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Yep, they gave the wrong number. Let them know.
We don't check them all because somebody could create a large JSON with an absurd number of
arguments and we'd spend cycles counting them all... easy DOS.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="k">raise</span> <span class="n">LoomWSBadArgumentsError</span><span class="p">(</span><span class="s2">&quot;too many fields given for request of type &#39;{}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>It was something else entirely.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="k">raise</span>
            <span class="k">except</span> <span class="n">LoomWSNoLoginError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="s2">&quot;not logged in&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>The method is not implemented.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">raise</span> <span class="n">LoomWSUnimplementedError</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <h6></h6>
<p>Protocol implementation</p>
<h6></h6>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <h1>User Information</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_user_preferences</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">):</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_user_preferences</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">preferences</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_user_stories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">):</span>
        <span class="n">stories</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_user_stories</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;stories&#39;</span><span class="p">:</span> <span class="n">stories</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_user_wikis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">):</span>
        <span class="n">wikis</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_user_wikis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wikis&#39;</span><span class="p">:</span> <span class="n">wikis</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <h1>Stories</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">create_story</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">wiki_id</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">add_preceding_subsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">to_parent</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">add_inner_subsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">to_parent</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">add_succeeding_subsection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">to_parent</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_story_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">story_id</span><span class="p">):</span>
        <span class="n">story</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_story</span><span class="p">(</span><span class="n">story_id</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;story_title&#39;</span><span class="p">:</span>  <span class="n">story</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;section_id&#39;</span><span class="p">:</span>   <span class="n">story</span><span class="p">[</span><span class="s1">&#39;section_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;wiki_id&#39;</span><span class="p">:</span>      <span class="n">story</span><span class="p">[</span><span class="s1">&#39;wiki_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;users&#39;</span><span class="p">:</span>        <span class="n">story</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span>      <span class="n">story</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_story_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">story_id</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hierarchy&#39;</span><span class="p">:</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_story_hierarchy</span><span class="p">(</span><span class="n">story_id</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_section_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">section_id</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hierarchy&#39;</span><span class="p">:</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_section_hierarchy</span><span class="p">(</span><span class="n">section_id</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="k">def</span> <span class="nf">get_section_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">section_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <h1>Wikis</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">create_wiki</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">add_segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">to_parent</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">to_parent</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_wiki_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">wiki_id</span><span class="p">):</span>
        <span class="n">wiki</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_wiki</span><span class="p">(</span><span class="n">wiki_id</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;wiki_title&#39;</span><span class="p">:</span>   <span class="n">wiki</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span>
            <span class="s1">&#39;segment_id&#39;</span><span class="p">:</span>   <span class="n">wiki</span><span class="p">[</span><span class="s1">&#39;segment_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;users&#39;</span><span class="p">:</span>        <span class="n">wiki</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">],</span>
            <span class="s1">&#39;summary&#39;</span><span class="p">:</span>      <span class="n">wiki</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_wiki_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">wiki_id</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hierarchy&#39;</span><span class="p">:</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_wiki_hierarchy</span><span class="p">(</span><span class="n">wiki_id</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_wiki_segment_hierarchy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">segment_id</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hierarchy&#39;</span><span class="p">:</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_interface</span><span class="o">.</span><span class="n">get_segment_hierarchy</span><span class="p">(</span><span class="n">segment_id</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">with_reply_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@requires_login</span>
    <span class="k">def</span> <span class="nf">get_wiki_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">page_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>TODO: Implement this.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">pass</span>

    <span class="n">DISPATCH</span> <span class="o">=</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>User Information</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="s1">&#39;get_user_preferences&#39;</span><span class="p">:</span>       <span class="n">get_user_preferences</span><span class="p">,</span>
        <span class="s1">&#39;get_user_stories&#39;</span><span class="p">:</span>           <span class="n">get_user_stories</span><span class="p">,</span>
        <span class="s1">&#39;get_user_wikis&#39;</span><span class="p">:</span>             <span class="n">get_user_wikis</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Stories</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="s1">&#39;create_story&#39;</span><span class="p">:</span>               <span class="n">create_story</span><span class="p">,</span>
        <span class="s1">&#39;add_preceding_subsection&#39;</span><span class="p">:</span>   <span class="n">add_preceding_subsection</span><span class="p">,</span>
        <span class="s1">&#39;add_inner_subsection&#39;</span><span class="p">:</span>       <span class="n">add_inner_subsection</span><span class="p">,</span>
        <span class="s1">&#39;add_succeeding_subsection&#39;</span><span class="p">:</span>  <span class="n">add_succeeding_subsection</span><span class="p">,</span>
        <span class="s1">&#39;get_story_information&#39;</span><span class="p">:</span>      <span class="n">get_story_information</span><span class="p">,</span>
        <span class="s1">&#39;get_story_hierarchy&#39;</span><span class="p">:</span>        <span class="n">get_story_hierarchy</span><span class="p">,</span>
        <span class="s1">&#39;get_section_hierarchy&#39;</span><span class="p">:</span>      <span class="n">get_section_hierarchy</span><span class="p">,</span>
        <span class="s1">&#39;get_section_content&#39;</span><span class="p">:</span>        <span class="n">get_section_content</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Wikis</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="s1">&#39;create_wiki&#39;</span><span class="p">:</span>                <span class="n">create_wiki</span><span class="p">,</span>
        <span class="s1">&#39;add_segment&#39;</span><span class="p">:</span>                <span class="n">add_segment</span><span class="p">,</span>
        <span class="s1">&#39;add_page&#39;</span><span class="p">:</span>                   <span class="n">add_page</span><span class="p">,</span>
        <span class="s1">&#39;get_wiki_information&#39;</span><span class="p">:</span>       <span class="n">get_wiki_information</span><span class="p">,</span>
        <span class="s1">&#39;get_wiki_hierarchy&#39;</span><span class="p">:</span>         <span class="n">get_wiki_hierarchy</span><span class="p">,</span>
        <span class="s1">&#39;get_wiki_segment_hierarchy&#39;</span><span class="p">:</span> <span class="n">get_wiki_segment_hierarchy</span><span class="p">,</span>
        <span class="s1">&#39;get_wiki_page&#39;</span><span class="p">:</span>              <span class="n">get_wiki_page</span><span class="p">,</span>
    <span class="p">}</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
